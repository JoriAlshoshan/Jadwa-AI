{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="page-container" style="padding:26px; max-width:1100px; margin:0 auto;">

  <!-- Top row: Title + Add Project -->
  <div style="display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:center; margin-bottom:14px; padding-right:10px;">
    <div style="min-width:320px;">
      <h1 style="margin:0; font-size:26px;">{% trans "Dashboard" %}</h1>
      <p style="margin:6px 0 0; color:#64748b; font-size:14px;">
        {% trans "Manage your projects and run feasibility analysis." %}
      </p>
    </div>

    <a href="{% url 'project_new' %}"
       class="btn"
       style="padding:10px 16px; font-size:14px; border-radius:999px; min-width:180px; text-align:center; margin-right:8px;">
      {% trans "Add Project" %}
    </a>
  </div>

  <!-- Profile summary (ONE card only) -->
  <div style="background:#fff; border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:16px 18px; margin-bottom:14px;">
    <div style="display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:center;">

      <div style="display:flex; gap:12px; align-items:center; min-width:260px;">
        <div style="width:52px; height:52px; border-radius:999px; overflow:hidden; background:#f1f5f9; border:1px solid rgba(15,23,42,.12); display:flex; align-items:center; justify-content:center;">
          {% if profile_image_url %}
            <img src="{{ profile_image_url }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
          {% else %}
            <span style="font-weight:900; color:#475569; font-size:18px;">
              {% if request.user.first_name %}
                {{ request.user.first_name|slice:":1"|upper }}
              {% elif request.user.get_full_name %}
                {{ request.user.get_full_name|slice:":1"|upper }}
              {% elif request.user.username %}
                {{ request.user.username|slice:":1"|upper }}
              {% else %}
                {{ request.user.email|slice:":1"|upper }}
              {% endif %}
            </span>
          {% endif %}
        </div>

        <div>
          <div style="font-weight:900; font-size:16px; line-height:1.2;">{{ profile_name }}</div>
          <div style="color:#64748b; font-size:13px; margin-top:3px;">{{ profile_email }}</div>

          {# ===== Location line (supports OTHER + avoids fake placeholders) ===== #}
          {% with r=region_label|default_if_none:"" c=city_label|default_if_none:"" %}
            {% if r %}
              <div style="margin-top:6px; font-size:13px; color:#64748b;">
                {{ r }}{% if c %}, {{ c }}{% endif %}
              </div>
            {% elif c %}
              <div style="margin-top:6px; font-size:13px; color:#64748b;">
                {{ c }}
              </div>
            {% else %}
              <div style="margin-top:6px; font-size:13px; color:#94a3b8;">
                {% trans "Location not set" %}
              </div>
            {% endif %}
          {% endwith %}

        </div>
      </div>

      <a href="{% url 'edit_profile' %}"
         class="btn btn-outline"
         style="padding:10px 16px; font-size:14px; border-radius:999px; min-width:180px; text-align:center;">
        {% trans "Edit Profile" %}
      </a>

    </div>
  </div>

  <!-- Projects list -->
  <div style="background:#fff; border:1px solid rgba(15,23,42,.10); border-radius:16px; overflow:hidden;">
    <div style="padding:12px 16px; border-bottom:1px solid rgba(15,23,42,.08); font-weight:800; font-size:14px;">
      {% trans "My Projects" %}
    </div>

    {% if projects %}
      <div style="padding:10px 14px;">
        {% for p in projects %}
          <div style="border:1px solid rgba(15,23,42,.08); border-radius:14px; padding:12px 14px; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">

              <div style="min-width:260px;">
                <div style="font-weight:900; font-size:16px; line-height:1.2;">
                  {{ p.project_name|default:"Project" }}
                </div>

                {% if p.last_result_id %}
                  <div style="margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:13px;">
                    <span style="padding:3px 9px; border-radius:999px; background:rgba(34,197,94,.10); border:1px solid rgba(34,197,94,.22);">
                      {% trans "Analyzed" %}
                    </span>

                    <span style="color:#64748b;">
                      {% trans "Score" %}: <b style="color:#0f172a;">{{ p.last_score_percent|floatformat:2 }}%</b>
                    </span>

                    <span style="color:#64748b;">
                      {% trans "Decision" %}: <b style="color:#0f172a;">{{ p.last_decision }}</b>
                    </span>

                    {% if is_ar %}
                      {% if p.recs_status_ar == "ready" and p.recs_ar %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(34,197,94,.10); border:1px solid rgba(34,197,94,.22); color:#166534;">
                          التوصيات جاهزة
                        </span>
                      {% elif p.recs_status_ar == "failed" %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.22); color:#991b1b;">
                          فشلت التوصيات
                        </span>
                      {% elif p.recs_status_ar == "translating" %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.22); color:#92400e;">
                          جاري الترجمة...
                        </span>
                      {% else %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.22); color:#92400e;">
                          لم يتم إنشاء التوصيات
                        </span>
                      {% endif %}
                    {% else %}
                      {% if p.recs_status_en == "ready" and p.recs_en %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(34,197,94,.10); border:1px solid rgba(34,197,94,.22); color:#166534;">
                          Recommendations: Ready
                        </span>
                      {% elif p.recs_status_en == "failed" %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.22); color:#991b1b;">
                          Recommendations: Failed
                        </span>
                      {% elif p.recs_status_en == "translating" %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.22); color:#92400e;">
                          Translating...
                        </span>
                      {% else %}
                        <span style="padding:3px 9px; border-radius:999px; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.22); color:#92400e;">
                          Not Generated
                        </span>
                      {% endif %}
                    {% endif %}
                  </div>
                {% else %}
                  <div style="margin-top:6px; font-size:13px; color:#64748b;">
                    <span style="padding:3px 9px; border-radius:999px; background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.22);">
                      {% trans "Not analyzed yet" %}
                    </span>
                  </div>
                {% endif %}
              </div>

              <!-- Actions -->
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;">
                {% if p.last_result_id %}
                  <a class="btn"
                     href="{% url 'analysis_result' p.last_result_id %}"
                     style="padding:9px 14px; font-size:13px; border-radius:999px; min-width:140px; text-align:center;">
                    {% trans "View Result" %}
                  </a>

                  <a href="{% url 'analysis_pdf' p.last_result_id %}"
                     style="font-size:13px; font-weight:700; color:#2563eb; text-decoration:none; padding:6px 4px;">
                    {% trans "Download PDF" %}
                  </a>
                {% else %}
                  <a class="btn btn-outline"
                     href="{% url 'run_analysis' p.id %}"
                     style="padding:9px 14px; font-size:13px; border-radius:999px; min-width:140px; text-align:center;">
                    {% trans "Run Analysis" %}
                  </a>
                {% endif %}
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:16px; color:#64748b; font-size:14px;">
        {% trans "No projects yet. Click Add Project to get started." %}
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
