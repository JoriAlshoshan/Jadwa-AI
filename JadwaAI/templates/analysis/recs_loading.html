{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analysis.css' %}">
{% endblock %}

{% block content %}
<div class="container analysis-page">

  <section class="analysis-hero">
    <h1 class="analysis-title">{% trans "Analysis Result" %}</h1>
    <p class="analysis-subtitle">{% trans "AI-powered feasibility insights for your project" %}</p>
  </section>

  <section class="analysis-grid">

    <div class="analysis-card">
      <h3 class="card-title">{% trans "Project Overview" %}</h3>

      <p><strong>{% trans "Project" %}:</strong> {{ result.project_name }}</p>

      <p>
        <strong>{% trans "Feasibility Probability" %}:</strong>
        <span class="probability">{{ feasibility_percent|floatformat:2 }}%</span>
      </p>

      <p class="status-row">
        <strong>{% trans "Status" %}:</strong>

        <span class="status-badge {% if result.label == 'Feasible' %}success{% else %}danger{% endif %}">
          {% if result.label == "Feasible" %}
            {% trans "Feasible" %}
          {% elif result.label == "Not Feasible" %}
            {% trans "Not Feasible" %}
          {% else %}
            {{ result.label }}
          {% endif %}
        </span>
      </p>
    </div>

    <div class="analysis-card">
      <h3 class="card-title">{% trans "AI Recommendations" %}</h3>

      <div class="skeleton-box">
        <div class="skeleton-line w-80"></div>
        <div class="skeleton-line w-100"></div>
        <div class="skeleton-line w-90"></div>
        <div class="skeleton-line w-95"></div>
        <div class="skeleton-line w-70"></div>
        <div class="skeleton-line w-100"></div>
        <div class="skeleton-line w-85"></div>
      </div>

      <p class="muted" style="margin-top:14px;">
{% load i18n %}
<p class="muted" style="margin-top:14px;">{% trans "Generating AI recommendations..." %}</p>
      </p>

      <form id="csrfForm">{% csrf_token %}</form>
    </div>

  </section>

  <div class="analysis-actions">
    <a href="{% url 'analysis_result' result.id %}" class="secondary-btn">
      {% trans "Back" %}
    </a>
  </div>

</div>

<script>
  (async () => {
    const token = document.querySelector('#csrfForm input[name="csrfmiddlewaretoken"]').value;

    await fetch("{% url 'generate_recs' result.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": token }
    }).catch(() => {});

    const statusUrl = "{% url 'recs_status' result.id %}";
    const doneUrl = "{% url 'analysis_result' result.id %}";

    const timer = setInterval(async () => {
      try {
        const res = await fetch(statusUrl, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (data.status === "ready" || data.status === "failed") {
          clearInterval(timer);
          window.location.href = doneUrl;
        }
      } catch (e) {}
    }, 1200);
  })();
</script>
{% endblock %}
