{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analysis.css' %}">
{% endblock %}

{% block content %}
<div class="container analysis-page">

  <!-- ===================== HERO ===================== -->
  <section class="analysis-hero">
    <h1 class="analysis-title">{% trans "Analysis Result" %}</h1>
    <p class="analysis-subtitle">
      {% trans "AI-powered feasibility insights for your project" %}
    </p>
  </section>

  <section class="analysis-grid">

    <!-- ===================== Project Overview ===================== -->
    <div class="analysis-card">
      <h3 class="card-title">{% trans "Project Overview" %}</h3>

      <p><strong>{% trans "Project" %}:</strong> {{ result.project_name }}</p>

      <p>
        <strong>{% trans "Feasibility Probability" %}:</strong>
        <span class="probability">{{ feasibility_percent|floatformat:2 }}%</span>
      </p>

      <p class="status-row">
        <strong>{% trans "Status" %}:</strong>
        {% if feasibility_percent >= 80 %}
          <span class="status-badge success">{% trans "Feasible" %}</span>
        {% elif feasibility_percent >= 50 %}
          <span class="status-badge warning">{% trans "Needs Improvement" %}</span>
        {% else %}
          <span class="status-badge danger">{% trans "Not Feasible" %}</span>
        {% endif %}
      </p>
    </div>

    <!-- ===================== AI Recommendations ===================== -->
    <div class="analysis-card">
      <h3 class="card-title">{% trans "AI Recommendations" %}</h3>

      <!-- âœ… Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„ØªÙˆØµÙŠØ§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©) -->
      {% if not recs_text %}
       <button id="startRecsBtn" type="button" class="primary-btn">
  Generate Recommendations
</button>

      {% endif %}

      <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙˆØµÙŠØ§Øª (Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯ÙƒØŒ Ù„ÙƒÙ† Ù…Ø®ÙÙŠ Ø¨Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø°Ø§ Ù…Ùˆ Ø¬Ø§Ù‡Ø²) -->
      <div id="recsBox"
           style="{% if recs_status == 'ready' and recs_text %}display:block;{% else %}display:none;{% endif %}"
           class="{% if recs_status == 'ready' and recs_text %}recommendations-box{% else %}recs-loading-wrap{% endif %}">

        {% if recs_status == "ready" and recs_text %}
          {{ recs_text|linebreaks }}

        {% elif recs_status == "failed" %}
          <p class="muted">{% trans "Failed to generate recommendations." %}</p>

        {% else %}
          <p class="muted">{% trans "Generating AI recommendationsâ€¦" %}</p>

          <div class="skeleton-box">
            <div class="skeleton-line w-80"></div>
            <div class="skeleton-line w-100"></div>
            <div class="skeleton-line w-90"></div>
            <div class="skeleton-line w-95"></div>
            <div class="skeleton-line w-70"></div>
            <div class="skeleton-line w-100"></div>
            <div class="skeleton-line w-85"></div>
          </div>
        {% endif %}
      </div>

      <!-- CSRF -->
      <form id="csrfForm">{% csrf_token %}</form>

      <!-- Config from Django -->
      <script>
        window.JADWA = {
          recsStatus: "{{ recs_status }}",
          hasOtherReady: "{{ has_other_ready|yesno:'true,false' }}",
          urlGenerate: "{% url 'generate_recs' result.id %}",
          urlTranslate: "{% url 'translate_recs' result.id %}",
          urlStatus: "{% url 'recs_status' result.id %}",
          reloadUrl: "{% url 'analysis_result' result.id %}"
        };
      </script>

      <!-- Auto Logic (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ÙƒØŒ Ø¨Ø³ Ù…Ø§ Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ù€ DOMContentLoaded) -->
      <script>
        function getCSRF() {
          return document.querySelector(
            "#csrfForm input[name=csrfmiddlewaretoken]"
          )?.value || "";
        }

        async function post(url) {
          const res = await fetch(url, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRF() }
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw data;
          return data;
        }

        async function pollStatus() {
          const cfg = window.JADWA;
          const timer = setInterval(async () => {
            try {
              const res = await fetch(cfg.urlStatus);
              const data = await res.json();
              if (data.status === "ready" || data.status === "failed") {
                clearInterval(timer);
                window.location.href = cfg.reloadUrl;
              }
            } catch (e) {}
          }, 1200);
        }

        async function ensureRecommendationsAuto() {
          const cfg = window.JADWA;

          // Ø¥Ø°Ø§ Ø¬Ø§Ù‡Ø²Ø© â†’ Ù„Ø§ ØªØ³ÙˆÙŠ Ø´ÙŠØ¡
          if (cfg.recsStatus === "ready") return;

          try {
            // ğŸ” ØªØ±Ø¬Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©
            if (cfg.hasOtherReady === "true") {
              await post(cfg.urlTranslate);
              window.location.href = cfg.reloadUrl;
              return;
            }

            // âš™ï¸ ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø´ÙŠØ¡
            await post(cfg.urlGenerate);
            await pollStatus();

          } catch (e) {
            window.location.href = cfg.reloadUrl;
          }
        }

        // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± ÙÙ‚Ø·
        document.addEventListener("DOMContentLoaded", () => {
          const cfg = window.JADWA;
          const btn = document.getElementById("startRecsBtn");
          const box = document.getElementById("recsBox");

          // Ù„Ùˆ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ù‚Ø¨Ù„ØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ø²Ø± ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
          if (cfg.recsStatus === "ready") {
            if (btn) btn.style.display = "none";
            if (box) box.style.display = "block";
            return;
          }

          // Ø¥Ø°Ø§ Ù…Ùˆ Ø¬Ø§Ù‡Ø²Ø©: Ù„Ø§ Ù†Ø³ÙˆÙŠ Ø´ÙŠØ¡ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
          if (btn) {
            btn.addEventListener("click", async () => {
              btn.disabled = true;
              btn.style.display = "none";
              if (box) box.style.display = "block";

              await ensureRecommendationsAuto();
            });
          } else {
            // Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ø²Ø± (Ù…Ø«Ù„Ø§Ù‹ ØªØ¨ÙŠÙ† ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹) Ù…Ø§ Ù†Ø³ÙˆÙŠ Ø´ÙŠØ¡
          }
        });
      </script>
    </div>

  </section>

  <!-- ===================== Actions ===================== -->
  <div class="analysis-actions">
    <a href="{% url 'analysis_pdf' result.id %}"
       class="btn secondary-btn pdf-btn"
       id="pdfBtn">
      <span class="pdf-text">{% trans "Download PDF" %}</span>
    </a>

    <a href="{% url 'dashboard' %}" class="btn secondary-btn">
      {% trans "Back to Dashboard" %}
    </a>
  </div>

  <script>
    const btn = document.getElementById("pdfBtn");
    if (btn) {
      btn.addEventListener("click", () => {
        btn.classList.add("is-loading");
        btn.setAttribute("aria-busy", "true");
      });
    }
  </script>

</div>
{% endblock %}
